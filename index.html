<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lowlife</title>
    <style>
        body { font-family: Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background: white; color: black; }
        h1 { text-align: center; text-transform: uppercase; letter-spacing: 2px; }
        
        /* Containers */
        .screen { max-width: 600px; margin: 0 auto; border: 1px solid #000; padding: 20px; display: none; }
        .visible { display: block; }
        
        /* Inputs & Buttons */
        input { display: block; width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #000; }
        button { display: block; width: 100%; padding: 15px; background: black; color: white; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { opacity: 0.8; }

        /* Game Elements */
        #game-info { border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px; text-align: center; font-weight: bold; }
        .player-row { display: flex; justify-content: space-between; padding: 10px; border: 1px solid #ccc; margin-bottom: 5px; align-items: center; }
        .my-turn { border: 2px solid black; background: #f0f0f0; }
        
        #event-log { height: 200px; overflow-y: auto; border: 1px solid #000; padding: 10px; background: #fafafa; font-family: monospace; font-size: 14px; margin-top: 20px; }
        #roll-box { font-size: 48px; text-align: center; margin: 20px 0; min-height: 60px; }
    </style>
</head>
<body>

    <h1>Lowlife</h1>

    <div id="lobby-screen" class="screen visible">
        <h3>Join Game</h3>
        <input type="text" id="username" placeholder="Enter Name">
        <input type="text" id="game-id" placeholder="Game ID (Leave empty to create new)">
        <button onclick="joinGame()">Enter Game</button>
        <p id="status" style="text-align:center; margin-top:10px;"></p>
    </div>

    <div id="game-screen" class="screen">
        <div id="game-info">Waiting for update...</div>
        
        <div id="roll-box"></div>
        <button id="spin-btn" onclick="doSpin()" disabled>SPIN</button>
        <button id="start-btn" onclick="doStart()" style="display:none; background:#444; margin-bottom:10px;">START GAME</button>

        <div id="player-list"></div>
        
        <div id="event-log"></div>
    </div>

    <script>
        // AUTO-CONNECTED TO YOUR RENDER ADDRESS
        const WS_URL = 'wss://lowlife-server-1.onrender.com';
        let ws;
        let myId = null;

        // Initialize connection immediately
        function connect() {
            document.getElementById('status').innerText = "Connecting to server...";
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                document.getElementById('status').innerText = "Connected. Ready to join.";
            };

            ws.onclose = () => {
                document.getElementById('status').innerText = "Disconnected. Refresh page.";
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };
        }

        function joinGame() {
            const name = document.getElementById('username').value || "Player";
            const gid = document.getElementById('game-id').value;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'joinGame',
                    playerName: name,
                    gameId: gid
                }));
            } else {
                alert("Not connected to server yet. Please wait.");
            }
        }

        function doStart() {
            ws.send(JSON.stringify({ type: 'startGame' }));
        }

        function doSpin() {
            ws.send(JSON.stringify({ type: 'spin' }));
            document.getElementById('spin-btn').disabled = true;
        }

        function handleMessage(msg) {
            if (msg.type === 'welcome') {
                myId = msg.yourId;
                document.getElementById('lobby-screen').classList.remove('visible');
                document.getElementById('game-screen').classList.add('visible');
                updateBoard(msg.gameState, msg.gameId);
            }
            
            if (msg.type === 'gameUpdate' || msg.type === 'gameStarted') {
                updateBoard(msg.gameState);
            }

            if (msg.type === 'roll') {
                document.getElementById('roll-box').innerText = "ðŸŽ² " + msg.roll;
            }

            if (msg.type === 'message' || msg.type === 'tardCard') {
                const log = document.getElementById('event-log');
                const text = msg.type === 'tardCard' ? `CARD: ${msg.card}` : msg.text;
                log.innerHTML += `<div>> ${text}</div>`;
                log.scrollTop = log.scrollHeight;
            }
        }

        function updateBoard(state, gameId) {
            if(gameId) document.getElementById('game-info').innerText = "GAME ID: " + gameId;
            
            // Show/Hide Start Button
            const startBtn = document.getElementById('start-btn');
            if (state.state === 'lobby') {
                startBtn.style.display = 'block';
                document.getElementById('roll-box').innerText = "Waiting to start...";
            } else {
                startBtn.style.display = 'none';
            }

            // Update Player List
            const list = document.getElementById('player-list');
            list.innerHTML = '';
            
            const isMyTurn = state.turn === myId;
            const spinBtn = document.getElementById('spin-btn');
            
            if (state.state === 'playing') {
                spinBtn.disabled = !isMyTurn;
                if(isMyTurn) document.getElementById('roll-box').innerText = "YOUR TURN";
            }

            Object.values(state.players).forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-row';
                if (state.turn === p.id && state.state === 'playing') div.classList.add('my-turn');
                
                div.innerHTML = `
                    <div>
                        <strong>${p.name}</strong><br>
                        <small>${p.character ? p.character.name : '...'}</small>
                    </div>
                    <div style="text-align:right;">
                        $${p.money}<br>
                        Space: ${p.position}
                    </div>
                `;
                list.appendChild(div);
            });
        }

        connect();
    </script>
</body>
</html>