<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>The Game of Lowlife</title>
<style>
  :root{--bg:#0b0b0e;--ink:#f5f5f7;--muted:#b7b7c2;--accent:#ffd54f;--border:#2a2a35;--card:#15161d}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui, Arial, sans-serif;display:flex;flex-direction:column;min-height:100vh}
  header{display:flex;align-items:center;justify-content:center;gap:12px;padding:8px 14px;border-bottom:1px solid var(--border);background:#111}
  header img{max-height:72px;display:block}
  header h1{margin:0;font-weight:900;letter-spacing:1px;display:none;color:var(--accent)}
  #app{display:flex;flex-direction:column;flex:1;min-height:0}
  #topbar{flex:0 0 auto;position:sticky;top:0;z-index:50;background:var(--bg);border-bottom:1px solid var(--border)}
  #controls{max-width:1200px;margin:0 auto;padding:8px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .btn{background:#e53935;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  input,select{background:#1b1b22;border:1px solid var(--border);color:#fff;border-radius:8px;padding:8px}
  label{color:var(--muted);font-size:.9rem}
  #status{color:var(--accent);min-width:280px}
  #spinnerWrap{display:flex;align-items:center;gap:8px;margin-left:auto}
  #spinner-container{position:relative;width:80px;height:80px}
  #spinner-wheel{position:absolute;inset:0;border-radius:50%;
    background:conic-gradient(#FF0000 0% 10%, #FF7F00 10% 20%, #FFFF00 20% 30%, #00FF00 30% 40%,
                              #0000FF 40% 50%, #4B0082 50% 60%, #8B00FF 60% 70%, #FFC0CB 70% 80%,
                              #F08080 80% 90%, #FFD700 90% 100%);
    box-shadow:0 0 12px rgba(0,0,0,.6);transform-origin:center center;transition:transform 4s cubic-bezier(.25,.46,.45,.94)}
  #arrow{position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:12px solid #fff;z-index:5}
  #spinBtn{min-width:100px}
  #main{display:flex;flex-direction:column;flex:1;min-height:0}
  #boardArea{flex:1;min-height:0;overflow:auto}
  #track{max-width:1200px;margin:8px auto;display:grid;grid-template-columns:repeat(20, 1fr);gap:4px;position:relative}
  .cell{min-height:44px;border:1px solid var(--border);background:#202028;color:#ddd;font-size:.7rem;display:flex;align-items:center;justify-content:center;text-align:center;border-radius:8px;padding:3px;position:relative}
  .cell small{display:block;color:#cfcfcf;font-size:.6rem;margin-top:2px}
  .cell.start{background:#30343c}      /* neutral start (NOT payday) */
  .cell.finish{background:#0d47a1}
  .cell.payday{background:#2e7d32;color:#fff;font-weight:800}
  .cell.tard{background:#5a189a}
  .cell.bankruptcy{background:#b71c1c}
  .cell.lottery{background:#795548}
  .cell.idtheft{background:#263238}
  .cell.extortion{background:#4e342e}
  .cell.active{outline:3px dashed #ffd54f}
  .tokens{position:absolute;inset:2px;display:flex;flex-wrap:wrap;gap:2px;align-content:flex-start;justify-content:flex-start;pointer-events:none}
  .token{width:14px;height:14px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:900;color:#000;text-shadow:0 0 2px #fff;border:1px solid rgba(0,0,0,.4)}
  #playersDock{flex:0 0 170px;border-top:1px solid var(--border);background:#0e0e12}
  #players{height:100%;max-width:1200px;margin:0 auto;padding:8px;display:flex;gap:12px;overflow:auto}
  .card{min-width:260px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
  .title{font-weight:900;margin-bottom:6px}
  .mono{font-variant-numeric:tabular-nums}
  .delta{font-size:.8rem;color:#9ccc65;margin-left:6px}
  #log{display:none}
  #modal{display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:100;}
  #modal .sheet{background:#181921;border:1px solid #2a2a35;border-radius:12px;max-width:560px;width:92%;padding:16px;}
</style>
</head>
<body>
<header>
  <img id="logo" src="lowlife logo.jpg" alt="The Game of Lowlife">
  <h1>The Game of Lowlife</h1>
</header>

<div id="app">
  <section id="topbar">
    <div id="controls">
      <label>Players:
        <select id="numPlayers"><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option></select>
      </label>
      <button id="buildNames" class="btn" type="button">Set Names</button>
      <div id="namesRow" style="display:flex;flex-wrap:wrap;gap:8px"></div>
      <button id="startBtn" class="btn" type="button" disabled>Start Game</button>
      <button id="spinBtn" class="btn" type="button" disabled>SPIN</button>
      <label>Voice: <select id="voiceSel"></select></label>
      <span style="color:#aaa">TARD deck: <span id="deckCount"></span></span>
      <span id="status">Enter names, then Start Game.</span>
      <div id="spinnerWrap" title="Spin result is read aloud">
        <div id="spinner-container">
          <div id="spinner-wheel"></div>
          <div id="arrow"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="main">
    <section id="boardArea">
      <div id="track"></div>
    </section>
    <section id="playersDock">
      <div id="players"></div>
    </section>
  </section>
</div>

<section id="log"></section>

<div id="modal">
  <div class="sheet">
    <h3 id="modalTitle" style="margin:0 0 8px 0;">TARD CARD</h3>
    <div id="modalBody" class="body" style="white-space:pre-wrap;line-height:1.4"></div>
    <div id="modalActions" class="actions" style="margin-top:12px;text-align:right"><button class="btn" onclick="closeModal()">OK</button></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ======= SAFE BOOT ======= */
  const $ = (sel)=>document.querySelector(sel);

  /* Logo fallback */
  const logo = $('#logo');
  logo.addEventListener('error', () => { document.querySelector('header h1').style.display='block'; logo.style.display='none'; });

  /* ======= CONSTANTS ======= */
  // #99 (index 98) = instant bankruptcy (no rescue)
  // #100 (index 99) = Finish — first to cross gets $5,000 bonus
  const EVENTS = [
    'Start',                                                       // 1
    'High school pregnancy, gain a family member',                 // 2
    'Sell weed at school, earn $500',                              // 3
    'Tard card',                                                   // 4
    'Payday',                                                      // 5
    'Breast implant bursts, pay $500 for surgery',                 // 6
    'Mom gets fired from the brothel, gain a family member',       // 7
    'Identity theft',                                              // 8
    'Waiting for dealer, miss a turn',                             // 9
    'Tard card',                                                   //10
    'Payday',                                                      //11
    'High on K, fall back two spaces',                             //12
    'Pick a pocket, earn $200',                                    //13
    'Add to shit mix',                                             //14
    'Tard card',                                                   //15
    'Bankruptcy, spin a five or nine to avoid financial ruin',     //16
    'Drink the shit mix',                                          //17
    'Gain a family member',                                        //18
    'Payday',                                                      //19
    'Tard card',                                                   //20
    'Extortion',                                                   //21
    'Identity theft',                                              //22
    'Wake up and need stitches in your head, miss a turn',         //23
    'Drink the shit mix',                                          //24
    'Add to shit mix',                                             //25
    'Payday',                                                      //26
    'Accidentally poison your spouse, lose a family member',       //27
    'Extortion',                                                   //28
    'Dine and dash, earn $100',                                    //29
    'Lottery, spin three or nine to win',                          //30
    'Payday',                                                      //31
    'Tard card',                                                   //32
    'Got a father\'s day abortion, lose a family member',          //33
    'Identity theft',                                              //34
    'Get laid off on your birthday, miss your next payday, do a shot', //35
    'Gerbiling incident, pay $1,000 for removal',                  //36
    'Payday',                                                      //37
    'Shotgun wedding, gain a family member',                       //38
    'Lottery, spin four or eight to win',                          //39
    'Crazy brother won\'t leave, gain a family member',            //40
    'Tard card',                                                   //41
    'Your TikTok goes viral, spin times 100',                      //42
    'Get a massage with a happy ending, pay $300',                 //43
    'Extortion',                                                   //44
    'Ha ha, it\'s twins, gain a family member, times two',         //45
    'Payday',                                                      //46
    'Feeling a bit tipsy, stumble forward one space',              //47
    'Bankruptcy, spin a three to avoid total ruin',                //48
    'Tard card',                                                   //49
    'Get work as dildo tester, earn $1,000',                       //50
    'Get a payday loan, earn $200',                                //51
    'Fly to Thailand to get a vagina installed, pay $1,000',       //52
    'Family delousing, pay 500 per member',                        //53
    'Payday',                                                      //54
    'Lottery, spin a one to win',                                  //55
    'Bankruptcy, you\'re fucked',                                  //56
    'Identity theft',                                              //57
    'Tard card',                                                   //58
    'Lost a kid at the mall, lose a family member',                //59
    'Got a part-time job as a porn fluffer, spin times 100',       //60
    'Payday',                                                      //61
    'Drink the shit mix',                                          //62
    'Steal $1,000 from any player',                                //63
    'Tard card',                                                   //64
    'Extortion',                                                   //65
    'Payday',                                                      //66
    'Go back three spaces to look for phone',                      //67
    'Lottery, spin a one or nine to win',                          //68
    'Surprise! I\'m your kid. Gain a family member.',              //69
    'Identity theft',                                              //70
    'Sell used sex toys online. Spin x 50.',                       //71
    'Tard card',                                                   //72
    'Buy used sex toys online. Pay $300.',                         //73
    'Payday',                                                      //74
    'Arrested in the Dominican. Pay $5,000.',                      //75
    'High on meth. Speed ahead two places.',                       //76
    'Tard card',                                                   //77
    'Bankruptcy. Spin 9 to avoid total ruin.',                     //78
    'Payday',                                                      //79
    'Tard card',                                                   //80
    'Identity theft',                                              //81
    'Extortion',                                                   //82
    'Lottery, spin two or eight to win',                           //83
    'Got caught on camera shoplifting, pay $400',                  //84
    'Found cash in a Crown Royal bag, earn $350',                  //85
    'Bachelor party side hustle, earn $700',                       //86
    'Baby mama drama, lose a family member',                       //87
    'Neighborhood brawl goes viral, spin times 100',               //88
    'Rent\'s due, pay $500',                                       //89
    'OnlyFans flop, pay $300 for lighting',                        //90
    'Win a radio contest, earn $250',                              //91
    'Stuck in detox, miss a turn',                                 //92
    'Payday',                                                      //93
    'Tard card',                                                   //94
    'Speed date disaster, go back three spaces',                   //95
    'Hot streak at the slots, earn $1,000',                        //96
    'High on shrooms, stumble forward one space',                  //97
    'Tard card',                                                   //98
    'Bankruptcy — instant, no rescue.',                            //99
    'Finish — first to cross gets $5,000 bonus.'                   //100
  ];
  const N_SQUARES = EVENTS.length;

  const TARD_CARDS = [
    'Grandma Joined a Cult – She ran off with a man named Moonbeam. Lose 1 family member.',
    'Dad Arrested in the Dominican Republic – “It was just one drink!” Lose 1 family member.',
    'Brother ODs – The good die young, the dumb die first. Lose 1 family member.',
    'DNA Disaster – Turns out you’re not the dad. Lose 1 family member.',
    'Family Car Fire – Somebody lit up while pumping gas. Lose 1 family member.',
    'Mom Gets Fired from the Brothel – She’s moving in. Gain 1 family member.',
    'Meth Lab Explosion – Dad survived and needs a couch. Gain 1 family member.',
    'Queer Cousin Gets Thrown Out – Glitter storm incoming. Gain 1 family member.',
    'Surprise! You’re My Real Dad – Someone’s calling you “Daddy,” and not the fun kind. Gain 1 family member.',
    'Bro Just Got Released – Fresh out and already asking for Wi-Fi. Gain 1 family member.',
    'Karma’s Bitch – Reverse any money loss.',
    'Block Their Blessing – Cancel another player’s money/bonus and take it.',
    'Public Humiliation – Force them to do the same dare or pay.',
    'Take the Couch – Swap one family member between you and them.',
    'Petty AF – Skip the next turn of whoever made you lose yours.',
    'Scabies Breakout – Pay $200 per family member to get deloused.',
    'Sing Us a Song – $500 bonus if recorded.',
    'Update Facebook: “I WON THE LOTTERY!”',
    'Make the Person to Your Left Laugh – Fail? Pay $100.',
    'Share Your Most Embarrassing Moment – Earn $200 if everyone cringes.',
    'Eat a Red Chili Pepper – Survive a full turn without water to gain $500.',
    'Give Your Neighbor a Pearl Necklace.',
    'Draw Your Best Cocksucker Lips in 5 Seconds.',
    'Give Someone a Lap Dance – Collect $100 per blush.',
    'Bad Trip – Woke up in another province. Lose 1 turn.',
    'Repo Man – Lose your vehicle or pay $500.',
    'Tax Refund Gone Wrong – Lose $1,000.',
    'OnlyFans Fame – Gain $1,500, lose your job.',
    'Evangelical Exorcism – Lose $200.',
    'Public Urination Ticket – Lose $300.',
    'Drag Bingo Win – Gain $300.',
    'Bad Investment – Lose $1,500.',
    'Power Outage Party – Gain one social connection and $100.',
    'STD Scare – Lose a turn.',
    'Eviction Notice – Move back home. Gain 1 family member.',
    // +10 payoff cards
    'Payoff Card – Pay the person on your character card. Spin x 50.',
    'Payoff Card – Pay the person on your character card. Spin x 50.',
    'Payoff Card – Pay the person on your character card. Spin x 50.',
    'Payoff Card – Pay the person on your character card. Spin x 50.',
    'Payoff Card – Pay the person on your character card. Spin x 50.',
    'Payoff Card – Pay the person on your character card. Spin x 50.',
    'Payoff Card – Pay the person on your character card. Spin x 50.',
    'Payoff Card – Pay the person on your character card. Spin x 50.',
    'Payoff Card – Pay the person on your character card. Spin x 50.',
    'Payoff Card – Pay the person on your character card. Spin x 50.'
  ];

  const CHARACTERS = [
    { name:'Slum Lord',         payday:6500, edu:'High School', paysOff:['Pornstar'] },
    { name:'Gold Digger',       payday:7000, edu:'Dropout',     paysOff:['Porn Producer'], rentImmunityOnLanding:true },
    { name:'Pimp',              payday:7000, edu:'High School', paysOff:['Dirty Cop'] },
    { name:'Drug Dealer',       payday:6500, edu:'Dropout',     paysOff:[] },
    { name:'Pornstar',          payday:6000, edu:'Dropout',     paysOff:['Pimp'] },
    { name:'Porn Producer',     payday:7000, edu:'High School', paysOff:['Gold Digger'] },
    { name:'Online Influencer', payday:6500, edu:'Dropout',     paysOff:['Dirty Cop'] },
    { name:'Dirty Cop',         payday:6500, edu:'High School', paysOff:[] }
  ];

  /* ======= STATE ======= */
  let players = [];
  let current = 0;
  let firstFinisherAwarded = false;
  let voices = [];
  let chosenVoice = null;
  let currentAngle = 0;
  let spinning=false;
  let tardIndex = 0;

  /* ======= ELEMENTS ======= */
  const numPlayersSel = $('#numPlayers');
  const buildNamesBtn = $('#buildNames');
  const startBtn = $('#startBtn');
  const spinBtn = $('#spinBtn');
  const namesRow = $('#namesRow');
  const statusEl = $('#status');
  const boardEl = $('#track');
  const playersEl = $('#players');
  const voiceSel = $('#voiceSel');
  const deckCountEl = $('#deckCount');
  const wheel = $('#spinner-wheel');

  /* ======= HELPERS ======= */
  function pickColor(i){ const pal=['#f44336','#2196f3','#4caf50','#ff9800','#e91e63','#00bcd4','#9c27b0','#8bc34a']; return pal[i%pal.length]; }
  function initials(name){ return (name.trim().split(/\s+/).map(s=>s[0]).join('').slice(0,2)||'?').toUpperCase(); }
  function updateDeckCount(){ deckCountEl.textContent = (TARD_CARDS.length - tardIndex) + ' / ' + TARD_CARDS.length; }
  function shuffleTard(){ TARD_CARDS.sort(()=>Math.random()-0.5); tardIndex = 0; updateDeckCount(); }

  /* ======= SPEECH (queued) ======= */
  const speechQueue=[]; let speaking=false;
  function queueSay(text){
    if(!('speechSynthesis' in window) || !text) return;
    speechQueue.push(String(text));
    if(!speaking) playNextUtterance();
  }
  function playNextUtterance(){
    if(speechQueue.length===0){ speaking=false; return; }
    speaking=true;
    const text = speechQueue.shift();
    const u = new SpeechSynthesisUtterance(text);
    if(chosenVoice) u.voice = chosenVoice;
    u.onend = ()=> playNextUtterance();
    try{ speechSynthesis.speak(u); }catch(e){ speaking=false; }
  }
  function populateVoices(){
    if(!('speechSynthesis' in window)){ voiceSel.innerHTML='<option>(no voices)</option>'; return; }
    voices=speechSynthesis.getVoices()||[]; voiceSel.innerHTML='';
    if(voices.length===0){ voiceSel.innerHTML='<option>(no voices)</option>'; chosenVoice=null; return; }
    voices.forEach((v,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=`${v.name} — ${v.lang}`; voiceSel.appendChild(o); });
    const idx=voices.findIndex(v=>/UK|British/i.test(v.name+v.lang)&&/en/i.test(v.lang));
    voiceSel.selectedIndex=idx>=0?idx:0; chosenVoice=voices[voiceSel.selectedIndex]||null;
  }
  if('speechSynthesis' in window){ populateVoices(); window.speechSynthesis.onvoiceschanged = populateVoices; }
  voiceSel.addEventListener('change', e=>{ chosenVoice=voices[e.target.value]; });

  /* ======= UI BUILD ======= */
  buildNamesBtn.addEventListener('click', ()=>{
    namesRow.innerHTML='';
    const n = parseInt(numPlayersSel.value)||2;
    for(let i=0;i<n;i++){
      const inp=document.createElement('input');
      inp.placeholder=`Player ${i+1} name`; inp.id=`pname_${i}`; inp.maxLength=20;
      namesRow.appendChild(inp);
    }
    startBtn.disabled=false;
    statusEl.textContent='Enter names, then Start Game.';
  });

  startBtn.addEventListener('click', ()=>{
    const n=parseInt(numPlayersSel.value)||2;
    const pool=[...CHARACTERS];
    players=[];
    for(let i=0;i<n;i++){
      const nm=(document.getElementById(`pname_${i}`)?.value||`Player ${i+1}`).trim();
      const idx=Math.floor(Math.random()*pool.length);
      const char=pool.splice(idx,1)[0];
      players.push({id:i+1,name:nm,character:char,position:0,money:0,family:0,missNextTurn:false,missNextPayday:false,lastMoneyDelta:0,color:pickColor(i)});
    }
    // Dropouts spin first
    players.sort((a,b)=> (a.character.edu==='Dropout')===(b.character.edu==='Dropout')?0:(a.character.edu==='Dropout'?-1:1));
    current=0; firstFinisherAwarded=false;
    renderBoard(); renderPlayers(); highlightCell(0); placeAllTokens();
    spinBtn.disabled=false;
    statusEl.textContent=`Game on. ${players[current].name} (${players[current].character.name}) to spin.`;
    updateDeckCount();
    queueSay(`Game on. ${players[current].name}, ${players[current].character.name}. Your turn to spin.`);
  });

  /* ======= BOARD ======= */
  function isTruePayday(text){ return text.trim().toLowerCase().startsWith('payday'); }
  function classify(text){
    const t=text.trim().toLowerCase();
    if(t.startsWith('start'))return'start';
    if(t.startsWith('finish'))return'finish';
    if(isTruePayday(text))return'payday';
    if(t.startsWith('tard card'))return'tard';
    if(t.includes('bankruptcy'))return'bankruptcy';
    if(t.startsWith('lottery'))return'lottery';
    if(t.startsWith('identity theft'))return'idtheft';
    if(t.startsWith('extortion'))return'extortion';
    return'normal';
  }
  function shortLabel(text){
    const t=text.trim().toLowerCase();
    if(isTruePayday(text))return'PAYDAY';
    if(t.startsWith('tard card'))return'TARD';
    if(t.startsWith('lottery'))return'LOTTO';
    if(t.includes('bankruptcy'))return'BANKRUPT';
    if(t.startsWith('identity theft'))return'ID THEFT';
    if(t.startsWith('extortion'))return'EXTORT';
    return text.length>22? text.slice(0,21)+'…':text;
  }
  function renderBoard(){
    boardEl.innerHTML='';
    for(let i=0;i<N_SQUARES;i++){
      const text=EVENTS[i]; const kind=classify(text);
      const c=document.createElement('div');
      c.className='cell '+(kind==='normal'?'':kind);
      c.dataset.index=i; c.title=text;
      c.innerHTML=`<div><b>${i+1}</b><small>${shortLabel(text)}</small></div><div class="tokens"></div>`;
      boardEl.appendChild(c);
    }
  }
  function highlightCell(idx){
    document.querySelectorAll('.cell').forEach(e=>e.classList.remove('active'));
    const el=document.querySelector(`.cell[data-index="${idx}"]`);
    if(el) el.classList.add('active');
  }
  function placeAllTokens(){
    document.querySelectorAll('.tokens').forEach(t=>t.innerHTML='');
    players.forEach(p=>{
      const cell=document.querySelector(`.cell[data-index="${p.position}"] .tokens`);
      if(cell){
        const el=document.createElement('div'); el.className='token';
        el.style.background=p.color; el.textContent=initials(p.name);
        cell.appendChild(el);
      }
    });
  }

  function renderPlayers(){
    playersEl.innerHTML='';
    players.forEach((p,i)=>{
      const d=document.createElement('div'); d.className='card';
      d.innerHTML=`<div class="title">
        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${p.color};margin-right:6px"></span>${p.name} — ${p.character.name}
      </div>
      <div>Edu: ${p.character.edu}</div>
      <div>Payday: <span class="mono">$${p.character.payday.toLocaleString()}</span></div>
      <div>Money: <span class="mono">$${p.money.toLocaleString()}</span> | Family: <span class="mono">${p.family}</span> <span class="delta">${p.lastMoneyDelta?`(${p.lastMoneyDelta>0?'+':''}${p.lastMoneyDelta})`:''}</span></div>
      <div>Pos: <span class="mono">#${p.position+1}</span> — ${EVENTS[p.position]}</div>`;
      if(i===current) d.style.outline='2px solid #ffd54f';
      playersEl.appendChild(d);
    });
    placeAllTokens();
  }

  /* ======= MODAL ======= */
  function showModal(title,body,buttons){
    document.getElementById('modalTitle').textContent=title;
    const bodyEl=document.getElementById('modalBody');
    bodyEl.innerHTML='';
    if(typeof body==='string') bodyEl.textContent=body; else bodyEl.appendChild(body);
    const actions=document.getElementById('modalActions');
    actions.innerHTML='';
    (buttons||[{label:'OK',action:closeModal}]).forEach(b=>{
      const btn=document.createElement('button'); btn.className='btn'; btn.textContent=b.label;
      btn.onclick=()=>{ b.action&&b.action(); };
      actions.appendChild(btn);
    });
    document.getElementById('modal').style.display='flex';
  }
  function closeModal(){ document.getElementById('modal').style.display='none'; }

  /* ======= SPINNER UI ======= */
  function animateToNumber(target){
    const centerAngle=(target-0.5)*36;
    const desiredMod=(270-centerAngle+360)%360;
    const currentMod=((currentAngle%360)+360)%360;
    const spins=6;
    const delta=((desiredMod-currentMod+360)%360)+spins*360;
    currentAngle+=delta;
    wheel.style.transform=`rotate(${currentAngle}deg)`;
  }

  /* ======= TURN ======= */
  spinBtn.addEventListener('click', ()=>{
    if(spinning || players.length===0) return;
    const roll = Math.floor(Math.random()*10)+1;
    spinning=true; spinBtn.disabled=true;
    queueSay(`You spun a ${roll}.`);
    animateToNumber(roll);
    setTimeout(()=>{
      resolveSpin(roll);
      spinning=false; spinBtn.disabled=false;
    }, 4000);
  });

  function resolveSpin(roll){
    const p=players[current]; if(!p) return;
    if(p.missNextTurn){
      p.missNextTurn=false;
      queueSay(`You spun ${roll}, but you miss your turn.`);
      endTurn();
      return;
    }
    const summary=[];
    advanceSteps(p, roll, summary);   // << step-by-step movement
    if(summary.length){ queueSay(`Summary: ${summary.join(' ')}`); }
    endTurn();
  }

  function endTurn(){
    current=(current+1)%players.length;
    statusEl.textContent=`${players[current].name} (${players[current].character.name}) to spin.`;
    queueSay(`${players[current].name}. ${players[current].character.name}. Your turn to spin.`);
  }

  /* ======= MOVEMENT (STEP-BY-STEP & RELIABLE) ======= */
  function processCrossingPayday(p, summary){
    if(p.missNextPayday){ p.missNextPayday=false; summary.push('Crossed PAYDAY: shot, no pay.'); return; }
    moneyDelta(p, p.character.payday);
    summary.push(`Crossed PAYDAY: +$${p.character.payday.toLocaleString()} and do a shot.`);
  }
  function processLandingPayday(p, summary){
    moneyDelta(p, p.character.payday);
    moneyDelta(p, 1000);
    summary.push(`Landed on PAYDAY: +$${p.character.payday.toLocaleString()} and $1,000 bonus.`);
  }
  function moneyDelta(p,amt){ p.money+=amt; p.lastMoneyDelta=amt; renderPlayers(); }
  function familyDelta(p,df){ p.family=Math.max(0,p.family+df); renderPlayers(); }

  function checkFinishBonus(p, summary){
    if(!firstFinisherAwarded && p.position===99){
      firstFinisherAwarded = true;
      moneyDelta(p, 5000);
      summary.push('Finish line! First to cross: +$5,000 bonus.');
    }
  }

  function advanceSteps(p, steps, summary){
    const startPos = p.position;
    // Move one square at a time (reliable count)
    for(let i=1;i<=steps;i++){
      const next = (p.position + 1) % N_SQUARES;
      // crossing effects apply on intermediate squares only
      if(i < steps){
        if(isTruePayday(EVENTS[next])) processCrossingPayday(p, summary);
        if(next === 99){ // crossing finish during movement
          if(!firstFinisherAwarded){ firstFinisherAwarded = true; moneyDelta(p,5000); summary.push('Finish line! First to cross: +$5,000 bonus.'); }
        }
      }
      p.position = next;
    }

    highlightCell(p.position);
    placeAllTokens();

    // Rent before landing effects
    chargeRent(p, summary);

    // Landing tile
    const tile = EVENTS[p.position];
    queueSay(tile);
    if(isTruePayday(tile)) processLandingPayday(p, summary);

    applySquare(p, tile, p.position, summary);
    checkFinishBonus(p, summary); // also true if you landed exactly on #100

    renderPlayers();
  }

  /* ======= RENT RULE ======= */
  function chargeRent(p, summary){
    const others = players.filter(o => o!==p && o.position === p.position);
    if(others.length === 0) return;
    if(p.character && p.character.name === 'Gold Digger'){
      summary.push('Rent immunity (Gold Digger).');
      return;
    }
    const rent = 500 * Math.max(1, (p.family||0) + 1);
    others.forEach(o=>{
      p.money -= rent; o.money += rent; p.lastMoneyDelta=-rent; o.lastMoneyDelta=rent;
      summary.push(`Paid $${rent.toLocaleString()} rent to ${o.name}.`);
    });
    renderPlayers();
  }

  /* ======= SQUARE LOGIC ======= */
  function drawTardCard(p, summary){
    if(tardIndex>=TARD_CARDS.length){ shuffleTard(); }
    const card=TARD_CARDS[tardIndex++]; updateDeckCount();
    showModal('TARD CARD', card, [{label:'OK',action:()=>closeModal()}]);
    queueSay(card);

    const t=card.toLowerCase();

    // Payoff card: always extra spin x50 (to target(s) or bank)
    if(t.includes('payoff card')){
      const payees=p.character.paysOff||[];
      const targets = players.filter(o => o!==p && payees.includes(o.character.name));
      closeModal();
      extraSpin(p, 50, 'Payoff — spin times fifty.', (amount)=>{
        if(targets.length){
          targets.forEach(o=>{ o.money += amount; o.lastMoneyDelta=amount; });
          p.money -= amount; p.lastMoneyDelta=-amount;
          summary.push(`Payoff: -$${amount.toLocaleString()} to ${targets.map(t=>t.name).join(', ')}.`);
          queueSay(`Payoff paid $${amount.toLocaleString()} to ${targets.map(t=>t.name).join(', ')}.`);
        }else{
          p.money -= amount; p.lastMoneyDelta=-amount;
          summary.push(`Payoff (no target): -$${amount.toLocaleString()} to bank.`);
          queueSay(`No payoff target. You pay the bank $${amount.toLocaleString()}.`);
        }
        renderPlayers();
      }, summary);
      return;
    }

    if(t.includes('lose 1 family')){ familyDelta(p,-1); }
    if(t.includes('gain 1 family')){ familyDelta(p,+1); }
    if(t.includes('skip the next turn')||t.includes('lose a turn')){ p.missNextTurn=true; }
    if(t.includes('pay $200 per family')){ const amt=200*p.family; moneyDelta(p,-amt); }
    if(t.includes('pay $100')){ moneyDelta(p,-100); }
    if(t.includes('earn $200')){ moneyDelta(p,200); }
    if(t.includes('gain $500')){ moneyDelta(p,500); }
    if(t.includes('gain $300')){ moneyDelta(p,300); }
    if(t.includes('lose $1,000')){ moneyDelta(p,-1000); }
    if(t.includes('gain $1,500')){ moneyDelta(p,1500); }
    if(t.includes('lose $200')){ moneyDelta(p,-200); }
    if(t.includes('lose $300')){ moneyDelta(p,-300); }
    if(t.includes('lose $1,500')){ moneyDelta(p,-1500); }
    if(t.includes('eviction notice')){ familyDelta(p,+1); }
  }

  function handleIdentityTheft(p, summary){
    if(players.length<=1){ return; }
    const wrap=document.createElement('div'); const sel=document.createElement('select');
    players.forEach(o=>{ if(o!==p){ const opt=document.createElement('option'); opt.value=o.id; opt.textContent=`${o.name} — ${o.character.name}`; sel.appendChild(opt);} });
    wrap.innerHTML='<div>Choose a player to steal their identity (character + position):</div>'; wrap.appendChild(sel);
    showModal('IDENTITY THEFT', wrap, [
      {label:'Cancel',action:closeModal},
      {label:'Steal',action:()=>{ const victim=players.find(x=>x.id===parseInt(sel.value));
        if(!victim){ closeModal(); return; }
        const tmpChar=p.character; p.character=victim.character; victim.character=tmpChar;
        const tmpPos=p.position; p.position=victim.position; victim.position=tmpPos;
        renderPlayers(); placeAllTokens(); closeModal();
        queueSay(`${p.name} stole ${victim.name}'s identity.`);
      }}
    ]);
  }

  function handleExtortion(p, summary){
    if(players.length<=1){ return; }
    const wrap=document.createElement('div'); const sel=document.createElement('select');
    players.forEach(o=>{ if(o!==p){ const opt=document.createElement('option'); opt.value=o.id; opt.textContent=`${o.name} — ${o.character.name}`; sel.appendChild(opt);} });
    wrap.innerHTML='<div>Choose a player to extort (they pay you spin × 100):</div>'; wrap.appendChild(sel);
    showModal('EXTORTION', wrap, [
      {label:'Cancel',action:closeModal},
      {label:'Extort',action:()=>{ const victim=players.find(x=>x.id===parseInt(sel.value));
        if(!victim){ closeModal(); return; }
        closeModal();
        extraSpin(p, 100, 'Extortion — spin times one hundred.', (amount)=>{
          victim.money -= amount; victim.lastMoneyDelta=-amount; p.money += amount; p.lastMoneyDelta=amount;
          renderPlayers();
          queueSay(`Extorted $${amount.toLocaleString()} from ${victim.name}.`);
          summary.push(`Extorted $${amount.toLocaleString()} from ${victim.name}.`);
        }, summary);
      }}
    ]);
  }

  function handleExtortionLikeSteal(p, amount, summary){
    if(players.length<=1){ return; }
    const wrap=document.createElement('div'); const sel=document.createElement('select');
    players.forEach(o=>{ if(o!==p){ const opt=document.createElement('option'); opt.value=o.id; opt.textContent=`${o.name}`; sel.appendChild(opt);} });
    wrap.innerHTML=`<div>Choose a player to steal $${amount.toLocaleString()} from:</div>`; wrap.appendChild(sel);
    showModal('STEAL', wrap, [
      {label:'Cancel',action:closeModal},
      {label:'Steal',action:()=>{ const victim=players.find(x=>x.id===parseInt(sel.value));
        if(!victim){ closeModal(); return; }
        victim.money -= amount; victim.lastMoneyDelta=-amount; p.money += amount; p.lastMoneyDelta=amount;
        renderPlayers(); closeModal();
        queueSay(`You stole $${amount.toLocaleString()} from ${victim.name}.`);
        summary.push(`Stole $${amount.toLocaleString()} from ${victim.name}.`);
      }}
    ]);
  }

  function bankruptcyRescue(p, textLower, summary){
    if(textLower.includes('instant, no rescue') || textLower.includes("you're fucked")){
      doBankruptImmediate(p);
      queueSay(`${p.name}, you just went bankrupt. You lose all your money.`);
      return;
    }
    let avoids=new Set();
    if(textLower.includes('spin a three')) avoids.add(3);
    if(textLower.includes('spin 9')) avoids.add(9);
    if(textLower.includes('five or nine') || textLower.includes('5 or 9')){ avoids.add(5); avoids.add(9); }
    if(avoids.size===0){ avoids.add(5); avoids.add(9); }
    const roll=Math.floor(Math.random()*10)+1;
    animateToNumber(roll);
    queueSay(`Bankruptcy rescue spin: ${roll}.`);
    setTimeout(()=>{
      if(avoids.has(roll)){ queueSay(`Avoided bankruptcy with ${roll}.`); }
      else{ doBankruptImmediate(p); queueSay(`${p.name}, you just went bankrupt. You lose all your money.`); }
      renderPlayers();
    }, 2800);
  }
  function doBankruptImmediate(p){
    const lost=p.money; p.money=0; p.lastMoneyDelta=-lost; renderPlayers();
  }

  function extraSpin(p, multiplier, announcePrefix, callback, summary, summaryTemplate){
    const roll = Math.floor(Math.random()*10)+1;
    animateToNumber(roll);
    queueSay(`${announcePrefix} You spun a ${roll}.`);
    setTimeout(()=>{
      const amount=roll*multiplier;
      callback(amount, roll);
      if(summary && summaryTemplate){
        summary.push(summaryTemplate.replace('$AMT', `$${amount.toLocaleString()}`));
      }
    }, 2800);
  }

  function applySquare(p, text, idx, summary){
    const t=text.toLowerCase();

    // Quick cues
    if(t.includes('waiting for dealer')) summary.push('You miss your next turn.');
    if(t.includes('add to shit mix')) summary.push('Add to the shit mix.');
    if(t.includes('drink the shit mix')) summary.push('Drink the shit mix.');
    if(t.includes('do a shot')) summary.push('Do a shot.');

    if(t.startsWith('identity theft')){ handleIdentityTheft(p, summary); return; }
    if(t.startsWith('tard card')){ drawTardCard(p, summary); return; }
    if(t.startsWith('extortion')){ handleExtortion(p, summary); }

    // spin x N patterns
    const m = /spin(?:\s+times)?\s*[x×]?\s*(\d+)/i.exec(text);
    if(m){
      const mult = parseInt(m[1],10);
      const earnLike = /sell|job|viral|work|tester|influencer|collect|win a radio/i.test(text) && !/pay/i.test(text);
      const payLike  = /pay/i.test(text) && !earnLike;
      if(payLike){ extraSpin(p, mult, `Extra spin times ${mult}.`, (amount)=>{ moneyDelta(p,-amount); }, summary, `Paid $AMT (×${mult}).`); }
      else{        extraSpin(p, mult, `Extra spin times ${mult}.`, (amount)=>{ moneyDelta(p, amount); }, summary, `Earned $AMT (×${mult}).`); }
      return;
    }

    // Money
    if(t.includes('earn $1000')||t.includes('earn $1,000')){ moneyDelta(p,1000); }
    if(t.includes('earn $100')){ moneyDelta(p,100); }
    if(t.includes('earn $700')){ moneyDelta(p,700); }
    if(t.includes('earn $500')){ moneyDelta(p,500); }
    if(t.includes('earn $400')){ moneyDelta(p,400); }
    if(t.includes('earn $350')){ moneyDelta(p,350); }
    if(t.includes('earn $300')){ moneyDelta(p,300); }
    if(t.includes('earn $250')){ moneyDelta(p,250); }

    if(t.includes('pay $700')){ moneyDelta(p,-700); }
    if(t.includes('pay $600')){ moneyDelta(p,-600); }
    if(t.includes('pay $500 for surgery')){ moneyDelta(p,-500); }
    if(t.includes('pay $500') && !t.includes('for surgery')){ moneyDelta(p,-500); }
    if(t.includes('pay 500 per member')){ const amt=500*p.family; moneyDelta(p,-amt); }
    if(t.includes('pay $400')){ moneyDelta(p,-400); }
    if(t.includes('pay $350')){ moneyDelta(p,-350); }
    if(t.includes('pay $300 for lighting')){ moneyDelta(p,-300); }
    if(t.includes('pay $300')){ moneyDelta(p,-300); }
    if(t.includes('pay $200')){ moneyDelta(p,-200); }
    if(t.includes('pay $1,000')){ moneyDelta(p,-1000); }
    if(t.includes('pay $5,000')){ moneyDelta(p,-5000); }
    if(t.includes('steal $1,000')){ handleExtortionLikeSteal(p,1000,summary); }

    // Family
    if(t.includes('gain a family member, times two')){ familyDelta(p,+2); }
    else if(t.includes('gain a family member')){ familyDelta(p,+1); }
    if(t.includes('lose a family member')){ familyDelta(p,-1); }

    // Turns
    if(t.includes('miss a turn') || t.includes('detox')){ p.missNextTurn=true; queueSay('You will miss your next turn.'); }
    if(t.includes('miss next payday')){ p.missNextPayday=true; queueSay('You will miss your next payday.'); }

    // Position nudges (chained)
    if(t.includes('go back three')){
      p.position=(p.position-3+N_SQUARES)%N_SQUARES; highlightCell(p.position); placeAllTokens();
      const nxt=EVENTS[p.position]; applySquare(p,nxt,p.position,summary); return;
    }
    if(t.includes('fall back two')){
      p.position=(p.position-2+N_SQUARES)%N_SQUARES; highlightCell(p.position); placeAllTokens();
      const nxt=EVENTS[p.position]; applySquare(p,nxt,p.position,summary); return;
    }
    if(t.includes('stumble forward one') || t.includes('speed ahead two places')){
      const jump = t.includes('speed ahead two') ? 2 : 1;
      p.position=(p.position+jump)%N_SQUARES; highlightCell(p.position); placeAllTokens();
      const nxt=EVENTS[p.position]; applySquare(p,nxt,p.position,summary); return;
    }

    if(t.startsWith('lottery')){ /* house logic live */ }
    if(t.includes('bankruptcy')){ bankruptcyRescue(p, t, summary); }
  }

  /* ======= INIT ======= */
  function updateAll(){ renderBoard(); renderPlayers(); shuffleTard(); }
  updateAll(); updateDeckCount(); statusEl.textContent='Enter names, then Start Game.';
  console.assert(EVENTS.length===100,'EVENTS should be 100, got '+EVENTS.length);
});
</script>
</body>
</html>
