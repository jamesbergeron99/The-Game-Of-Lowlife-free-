<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Game of Lowlife — Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 24px; background: #111; color: #eee; }
    h1 { margin: 0 0 16px; font-size: 22px; }
    .wrap { display: grid; gap: 16px; grid-template-columns: 1fr; max-width: 900px; margin: 0 auto; }
    .card { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 10px; padding: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 0 0 auto; }
    input, select, button, textarea {
      background: #0f0f0f; color: #eee; border: 1px solid #2a2a2a; border-radius: 8px; padding: 10px;
      font-size: 14px;
    }
    input:disabled, select:disabled, button:disabled, textarea:disabled { opacity: .5; }
    button { cursor: pointer; }
    button.primary { background: #2563eb; border-color: #2563eb; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .tag { background: #222; border: 1px solid #333; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .status { white-space: pre-wrap; font-size: 12px; color: #aaa; }
    .grid { display: grid; gap: 8px; }
    .grid2 { display: grid; gap: 8px; grid-template-columns: repeat(2, minmax(0, 1fr)); }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 8px; border-bottom: 1px solid #222; font-size: 14px; }
    .ok { color: #22c55e; }
    .warn { color: #f59e0b; }
    .err { color: #ef4444; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>The Game of Lowlife — Online Multiplayer</h1>

    <!-- CONNECTION -->
    <div class="card">
      <div class="row">
        <div>Server:</div>
        <div id="serverUrl" class="mono tag"></div>
        <div>Socket:</div>
        <div id="connState" class="tag">connecting…</div>
      </div>
      <div id="status" class="status" style="margin-top:8px;"></div>
    </div>

    <!-- HOST PANEL -->
    <div class="card" id="hostCard">
      <h2 style="margin-top:0;">Host a Game</h2>
      <div class="grid">
        <div class="row">
          <button id="createGameBtn" class="primary">Create Game</button>
          <div>Code: <span id="gameCode" class="mono tag">—</span></div>
          <div>Role: <span id="roleTag" class="tag">—</span></div>
        </div>

        <div class="row">
          <label for="numPlayers">Players</label>
          <select id="numPlayers">
            <option>2</option><option>3</option><option>4</option>
            <option>5</option><option>6</option><option>7</option><option>8</option>
          </select>
          <button id="saveSettingsBtn">Apply</button>
          <span id="playersSaved" class="ok" style="display:none;">Saved</span>
        </div>

        <div>
          <div style="margin-bottom:6px;">Player Names (auto-generates if left blank):</div>
          <div id="nameInputs" class="grid2"></div>
        </div>

        <div class="row">
          <button id="startGameBtn" class="primary">Start Game</button>
        </div>

        <div>
          <div>Lobby</div>
          <ul id="lobbyList" style="padding-left:18px; margin:8px 0 0;"></ul>
        </div>
      </div>
    </div>

    <!-- JOIN PANEL -->
    <div class="card" id="joinCard">
      <h2 style="margin-top:0;">Join a Game</h2>
      <div class="row">
        <input id="joinCode" placeholder="Enter 4-letter code" class="mono" maxlength="4" />
        <input id="joinName" placeholder="Your name" />
        <button id="joinBtn">Join</button>
      </div>
    </div>

    <!-- GAME PANEL -->
    <div class="card" id="gameCard" style="display:none;">
      <h2 style="margin-top:0;">Game</h2>
      <div class="row">
        <div>Current Player:</div>
        <div id="currentPlayer" class="tag mono">—</div>
        <button id="spinBtn" class="primary" disabled>SPIN</button>
      </div>

      <div style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>#</th><th>Name</th><th>Character</th><th>Money</th><th>Pos</th><th>Last Δ</th>
            </tr>
          </thead>
          <tbody id="playersTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    // ====== CONFIG ======
    const SERVER_URL = "https://lowlife-server-1.onrender.com"; // Your Render Web Service
    const MAX_PLAYERS = 8;

    // ====== ELEMENTS ======
    const el = (id) => document.getElementById(id);
    const serverUrlEl = el("serverUrl");
    const connStateEl = el("connState");
    const statusEl = el("status");

    const createGameBtn = el("createGameBtn");
    const gameCodeEl = el("gameCode");
    const roleTagEl = el("roleTag");

    const numPlayersSel = el("numPlayers");
    const saveSettingsBtn = el("saveSettingsBtn");
    const playersSavedEl = el("playersSaved");
    const nameInputsWrap = el("nameInputs");
    const lobbyListEl = el("lobbyList");

    const joinCodeEl = el("joinCode");
    const joinNameEl = el("joinName");
    const joinBtn = el("joinBtn");

    const gameCard = el("gameCard");
    const currentPlayerEl = el("currentPlayer");
    const playersTable = el("playersTable");
    const spinBtn = el("spinBtn");

    // ====== STATE ======
    let socket = null;
    let myId = null;
    let currentCode = null;
    let isHost = false;
    let lastKnownState = null;

    // ====== HELPERS ======
    function setStatus(msg, kind = "") {
      const prefix = kind === "err" ? "❌ " : kind === "ok" ? "✅ " : kind === "warn" ? "⚠️ " : "";
      statusEl.textContent = prefix + msg;
      statusEl.className = "status " + (kind || "");
    }
    function toggleHostControls(enabled) {
      createGameBtn.disabled = !enabled;
      numPlayersSel.disabled = !enabled;
      saveSettingsBtn.disabled = !enabled;
    }
    function ensureNameInputs(n) {
      nameInputsWrap.innerHTML = "";
      for (let i = 0; i < n; i++) {
        const div = document.createElement("div");
        const input = document.createElement("input");
        input.placeholder = `Player ${i+1} name`;
        input.id = `pname_${i}`;
        div.appendChild(input);
        nameInputsWrap.appendChild(div);
      }
    }
    function getNamesFromInputs(n) {
      const names = [];
      for (let i = 0; i < n; i++) {
        const v = (el(`pname_${i}`)?.value || "").trim();
        names.push(v || `Player ${i+1}`);
      }
      return names;
    }
    function renderLobby(list) {
      lobbyListEl.innerHTML = "";
      (list || []).forEach((p,i) => {
        const li = document.createElement("li");
        li.textContent = `${i+1}. ${p.name || "Player"}`;
        lobbyListEl.appendChild(li);
      });
    }
    function renderPlayersTable(state) {
      playersTable.innerHTML = "";
      if (!state?.players) return;
      state.players.forEach((p, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${p.name || "-"}</td>
          <td>${p.character?.name || "-"}</td>
          <td>${typeof p.money === "number" ? "$" + p.money.toLocaleString() : "-"}</td>
          <td>${p.position ?? "-"}</td>
          <td>${p.lastMoneyDelta ? (p.lastMoneyDelta > 0 ? "+" : "") + "$" + Math.abs(p.lastMoneyDelta).toLocaleString() : "0"}</td>
        `;
        playersTable.appendChild(tr);
      });
    }
    function updateCurrentPlayerBadge(st
